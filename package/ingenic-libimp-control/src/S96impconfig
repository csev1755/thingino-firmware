#!/bin/sh

. /etc/init.d/rc.common

config="/etc/imp.conf"

check_imp() {
	printf "%-35s" " Connecting to libimp-control"
	is_streamer_disabled && disabled

	local soc=$(soc -f)
	if [ "$soc" = "t10" ] || [ "$soc" = "t20" ]; then
		isp_path="/proc/jz/isp/isp_info"
	else
		isp_path="/proc/jz/isp/isp-fs"
	fi

	local i=0
	while :; do
		if grep -Eq "running|Software" $isp_path; then
			imp-control getdeviceid > /dev/null && ok && return
		fi
		i=$((i + 1))
		sleep 1
		[ $i -gt 10 ] && fail && exit 1
	done
}

restore_config() {
        printf "%-35s" " Restoring IMP configuration"
        [ -f "$config" ] || disabled
        while read -r line; do
                echo -e " * $line"
                imp-control $line > /dev/null
        done < $config
}

start() {
	starting_batch
        check_imp
        restore_config
        echo "Done"
}

case "$1" in
	start | restart | reload)
		start
		;;
	stop)
		:
		;;
	*)
		die 1 "Usage: $0 {start|restart|reload}"
		;;
esac

exit 0
