#!/bin/sh

. /etc/init.d/rc.common

CNET=172.16.0

ssid=$(envvar wlanssid)
pass=$(envvar wlanpass)

timeout() {
	sleep 300 && $0 stop
}

init_portal() {
	starting
	wlan0_check || disabled
	[ -n "$ssid" ] && [ -n "$pass" ] && disabled

	ip a add dev wlan0 $CNET.1/24
	ip link set wlan0 up
	ip route add $CNET.0/24 dev wlan0 > /dev/null 2>&1

	start-stop-daemon -S -x /sbin/udhcpd -- -S -I $CNET.1 /etc/udhcpd.conf 2>&1 | log
	start-stop-daemon -S -x /sbin/dnsd -- -i $CNET.1 -c /etc/dnsd.conf -d 2>&1 | log

	mac_address=$(ip link show wlan0 | awk '/ether/ {print $2}')
	last_two=$(echo $mac_address | awk -F: '{print $(NF-1) $NF}')
	sed -i "/ssid=\"THINGINO-\"$/ s/\"$/$last_two\"/" /etc/wpa_ap.conf

	start-stop-daemon -S -x /sbin/wpa_supplicant -- -i wlan0 -B -c /etc/wpa_ap.conf 2>&1 | log
	[ $? = 0 ] && ok || fail

	timeout &
}

case "$1" in
	start)
		init_portal
		;;
	stop)
		start-stop-daemon -K -q -x /sbin/udhcpd
		start-stop-daemon -K -q -x /sbin/dnsd
		start-stop-daemon -K -q -x /sbin/wpa_supplicant
		ip address delete dev wlan0 $CNET.1/24
		ip link set wlan0 down
		;;
	reload | restart)
		true
		;;
	*)
		die 1 "Usage: $0 {start|stop|reload|restart}"
		;;
esac

exit 0
