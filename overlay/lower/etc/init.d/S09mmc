#!/bin/sh

. /etc/init.d/rc.common

SOC_FAMILY=$(/usr/sbin/soc -f)
SOC_MODEL=$(/usr/sbin/soc -m)

MMC_MODULE="jzmmc_v12"

MMC_GPIO_CD=$(envvar gpio_mmc_cd)
MMC_GPIO_PWR=$(envvar gpio_mmc_power)

# Default CD-PIN for Ingenic PB27 (GPIO59)
[ -z "$MMC_GPIO_CD" ] && MMC_GPIO_CD="59"

set_gpios() {
	# Set addtional MMC GPIOs
	# This needs to run AFTER the driver has been loaded for the sd card to mount during boot
	if [ ${#MMC_GPIO_PWR} -eq 3 ] && [ "${MMC_GPIO_PWR%[oO]}" != "$MMC_GPIO_PWR" ]; then
		case "${MMC_GPIO_PWR#??}" in
			"O") gpio set ${MMC_GPIO_PWR%[oO]} 1 2>&1 | log ;;
			"o") gpio set ${MMC_GPIO_PWR%[oO]} 0 2>&1 | log ;;
		esac
	fi
}

load_module() {
	grep -q "$MMC_MODULE" /proc/modules && die 1 "$MMC_MODULE is already loaded"

	modprobe $MMC_MODULE $MMC_PARAM || die 1 "FAIL"

	ok
	set_gpios
}

start() {
	starting

	MMC_PARAM="cd_gpio_pin=$MMC_GPIO_CD"

	# Check if MDIO directory exists
	if [ -d /proc/jz/mdio ]; then
		echo -n "/proc/jz/mdio directory exists, MSC1 disabled... "
	else
		case "$SOC_FAMILY" in
			t10 | t20 | t21 | t30 | t40 | t41)
				# do nothing
				;;
			t23)
				die 1 "Unsupported: T23"
				;;
			t31)
				if [ "$SOC_MODEL" = "t31a" ] || [ "$SOC_MODEL" = "t31al" ]; then
					echo "Skipping GPIO setup for $SOC_MODEL"
					return 1
				else
					gpio-diag pb08 func 1 drive 2
					gpio-diag pb09 func 1 drive 1
					gpio-diag pb10 func 1 drive 1
					gpio-diag pb11 func 1 drive 1
					gpio-diag pb13 func 1 drive 1
					gpio-diag pb14 func 1 drive 1
				fi
				;;
			*)
				die 1 "Unsupported SOC type: $SOC_FAMILY"
				;;
		esac
	fi
	load_module
}

case "$1" in
	start)
		$1
		;;
	stop)
		true
		;;
	reload | restart)
		stop
		sleep 1
		start
		;;
	*)
		die 1 "Usage: $0 {start}"
		;;
esac

exit 0
